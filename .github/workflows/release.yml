name: release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: read

jobs:
  build-linux-x86_64-glibc217:
    runs-on: ubuntu-latest
    env:
      IMAGE_REPO: ${{ github.repository == 'baaaaaaaka/cursor_cli_manager' && format('ghcr.io/{0}/ccm-linux-builder', github.repository_owner) || format('ghcr.io/{0}/{1}/ccm-linux-builder', github.repository_owner, github.event.repository.name) }}
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR (pull builder image)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build linux binary (builder image)
        env:
          CCM_LINUX_BUILDER_IMAGE: ${{ env.IMAGE_REPO }}:py311
          CCM_LINUX_VARIANT: common
        run: |
          set -euxo pipefail
          bash scripts/build_linux_binary_docker.sh

      - uses: actions/upload-artifact@v4
        with:
          name: ccm-linux-x86_64-glibc217.tar.gz
          path: out/ccm-linux-x86_64-glibc217.tar.gz

  build-linux-x86_64-nc5:
    runs-on: ubuntu-latest
    env:
      IMAGE_REPO: ${{ github.repository == 'baaaaaaaka/cursor_cli_manager' && format('ghcr.io/{0}/ccm-linux-builder', github.repository_owner) || format('ghcr.io/{0}/{1}/ccm-linux-builder', github.repository_owner, github.event.repository.name) }}
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR (pull builder image)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build linux binary (builder image)
        env:
          CCM_LINUX_BUILDER_IMAGE: ${{ env.IMAGE_REPO }}:py311
          CCM_LINUX_VARIANT: nc5
        run: |
          set -euxo pipefail
          bash scripts/build_linux_binary_docker.sh

      - uses: actions/upload-artifact@v4
        with:
          name: ccm-linux-x86_64-nc5.tar.gz
          path: out/ccm-linux-x86_64-nc5.tar.gz

  build-linux-x86_64-nc6:
    runs-on: ubuntu-latest
    env:
      IMAGE_REPO: ${{ github.repository == 'baaaaaaaka/cursor_cli_manager' && format('ghcr.io/{0}/ccm-linux-builder', github.repository_owner) || format('ghcr.io/{0}/{1}/ccm-linux-builder', github.repository_owner, github.event.repository.name) }}
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR (pull builder image)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build linux binary (builder image)
        env:
          CCM_LINUX_BUILDER_IMAGE: ${{ env.IMAGE_REPO }}:py311-nc6
          CCM_LINUX_VARIANT: nc6
        run: |
          set -euxo pipefail
          bash scripts/build_linux_binary_docker.sh

      - uses: actions/upload-artifact@v4
        with:
          name: ccm-linux-x86_64-nc6.tar.gz
          path: out/ccm-linux-x86_64-nc6.tar.gz

  build-macos-x86_64:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build macOS x86_64 binary
        run: |
          set -euxo pipefail
          python -m pip install -U pip "setuptools<69" wheel pyinstaller certifi
          python -m PyInstaller --clean -n ccm --collect-data certifi --specpath out/_spec --distpath out/_dist --workpath out/_build cursor_cli_manager/__main__.py
          tar -C out/_dist -czf out/ccm-macos-x86_64.tar.gz ccm

      - uses: actions/upload-artifact@v4
        with:
          name: ccm-macos-x86_64.tar.gz
          path: out/ccm-macos-x86_64.tar.gz

  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build macOS arm64 binary
        run: |
          set -euxo pipefail
          python -m pip install -U pip "setuptools<69" wheel pyinstaller certifi
          python -m PyInstaller --clean -n ccm --collect-data certifi --specpath out/_spec --distpath out/_dist --workpath out/_build cursor_cli_manager/__main__.py
          tar -C out/_dist -czf out/ccm-macos-arm64.tar.gz ccm

      - uses: actions/upload-artifact@v4
        with:
          name: ccm-macos-arm64.tar.gz
          path: out/ccm-macos-arm64.tar.gz

  smoke-linux:
    runs-on: ubuntu-latest
    needs:
      - build-linux-x86_64-glibc217
      - build-linux-x86_64-nc5
      - build-linux-x86_64-nc6
    env:
      UPGRADE_FROM_TAG: v0.6.4
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: glibc217
            asset: ccm-linux-x86_64-glibc217.tar.gz
            ncurses_variant: common
          - name: nc5
            asset: ccm-linux-x86_64-nc5.tar.gz
            ncurses_variant: nc5
          - name: nc6
            asset: ccm-linux-x86_64-nc6.tar.gz
            ncurses_variant: nc6
    steps:
      - uses: actions/checkout@v4

      - name: Download linux artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.asset }}
          path: dist

      - name: Prepare checksums.txt
        run: |
          set -euxo pipefail
          cd dist
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "${{ matrix.asset }}" > checksums.txt
          else
            shasum -a 256 "${{ matrix.asset }}" > checksums.txt
          fi

      - name: Download old linux asset
        run: |
          set -euxo pipefail
          OLD_DIR="${RUNNER_TEMP}/ccm-old"
          OLD_ASSET="ccm-linux-x86_64-glibc217.tar.gz"
          OLD_URL="https://github.com/${{ github.repository }}/releases/download/${UPGRADE_FROM_TAG}/${OLD_ASSET}"
          mkdir -p "${OLD_DIR}"
          curl -fsSL "${OLD_URL}" -o "${OLD_DIR}/${OLD_ASSET}"
          if command -v sha256sum >/dev/null 2>&1; then
            (cd "${OLD_DIR}" && sha256sum "${OLD_ASSET}" > checksums.txt)
          else
            (cd "${OLD_DIR}" && shasum -a 256 "${OLD_ASSET}" > checksums.txt)
          fi

      - name: Install old linux bundle
        run: |
          set -euxo pipefail
          export CCM_INSTALL_FROM_DIR="${RUNNER_TEMP}/ccm-old"
          export CCM_INSTALL_DEST="${RUNNER_TEMP}/ccm-test/bin"
          export CCM_INSTALL_ROOT="${RUNNER_TEMP}/ccm-test/root"
          export CCM_INSTALL_TAG="${UPGRADE_FROM_TAG}"
          export CCM_INSTALL_NCURSES_VARIANT="common"
          export CCM_INSTALL_OS="Linux"
          export CCM_INSTALL_ARCH="x86_64"
          mkdir -p "${CCM_INSTALL_DEST}" "${CCM_INSTALL_ROOT}" "${RUNNER_TEMP}/ccm-test/config"
          sh scripts/install_ccm.sh
          echo "OLD_CURRENT=$(readlink "${CCM_INSTALL_ROOT}/current")" >> "${GITHUB_ENV}"

      - name: Upgrade to new linux bundle
        run: |
          set -euxo pipefail
          export CCM_INSTALL_FROM_DIR="${PWD}/dist"
          export CCM_INSTALL_DEST="${RUNNER_TEMP}/ccm-test/bin"
          export CCM_INSTALL_ROOT="${RUNNER_TEMP}/ccm-test/root"
          export CCM_INSTALL_NCURSES_VARIANT="${{ matrix.ncurses_variant }}"
          export CCM_INSTALL_OS="Linux"
          export CCM_INSTALL_ARCH="x86_64"
          unset CCM_INSTALL_TAG || true
          sh scripts/install_ccm.sh
          NEW_CURRENT="$(readlink "${CCM_INSTALL_ROOT}/current")"
          if [ -n "${OLD_CURRENT:-}" ] && [ "${NEW_CURRENT}" = "${OLD_CURRENT}" ]; then
            echo "current symlink was not updated"
            exit 1
          fi

      - name: Smoke test linux bundle
        run: |
          set -euxo pipefail
          CFG="${RUNNER_TEMP}/ccm-test/config"
          "${RUNNER_TEMP}/ccm-test/bin/ccm" --config-dir "${CFG}" doctor
          "${RUNNER_TEMP}/ccm-test/bin/ccm" --config-dir "${CFG}" list --pretty
          "${RUNNER_TEMP}/ccm-test/bin/cursor-cli-manager" --config-dir "${CFG}" list

  smoke-macos-x86_64:
    runs-on: macos-15-intel
    needs:
      - build-macos-x86_64
    env:
      UPGRADE_FROM_TAG: v0.6.4
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: ccm-macos-x86_64.tar.gz
          path: dist

      - name: Prepare checksums.txt
        run: |
          set -euxo pipefail
          cd dist
          shasum -a 256 ccm-macos-x86_64.tar.gz > checksums.txt

      - name: Download old macOS x86_64 asset
        run: |
          set -euxo pipefail
          OLD_DIR="${RUNNER_TEMP}/ccm-old"
          OLD_ASSET="ccm-macos-x86_64.tar.gz"
          OLD_URL="https://github.com/${{ github.repository }}/releases/download/${UPGRADE_FROM_TAG}/${OLD_ASSET}"
          mkdir -p "${OLD_DIR}"
          curl -fsSL "${OLD_URL}" -o "${OLD_DIR}/${OLD_ASSET}"
          (cd "${OLD_DIR}" && shasum -a 256 "${OLD_ASSET}" > checksums.txt)

      - name: Install old macOS x86_64 bundle
        run: |
          set -euxo pipefail
          export CCM_INSTALL_FROM_DIR="${RUNNER_TEMP}/ccm-old"
          export CCM_INSTALL_DEST="${RUNNER_TEMP}/ccm-test/bin"
          export CCM_INSTALL_ROOT="${RUNNER_TEMP}/ccm-test/root"
          export CCM_INSTALL_TAG="${UPGRADE_FROM_TAG}"
          export CCM_INSTALL_OS="Darwin"
          export CCM_INSTALL_ARCH="x86_64"
          mkdir -p "${CCM_INSTALL_DEST}" "${CCM_INSTALL_ROOT}" "${RUNNER_TEMP}/ccm-test/config"
          sh scripts/install_ccm.sh
          echo "OLD_CURRENT=$(readlink "${CCM_INSTALL_ROOT}/current")" >> "${GITHUB_ENV}"

      - name: Upgrade to new macOS x86_64 bundle
        run: |
          set -euxo pipefail
          export CCM_INSTALL_FROM_DIR="${PWD}/dist"
          export CCM_INSTALL_DEST="${RUNNER_TEMP}/ccm-test/bin"
          export CCM_INSTALL_ROOT="${RUNNER_TEMP}/ccm-test/root"
          export CCM_INSTALL_OS="Darwin"
          export CCM_INSTALL_ARCH="x86_64"
          unset CCM_INSTALL_TAG || true
          sh scripts/install_ccm.sh
          NEW_CURRENT="$(readlink "${CCM_INSTALL_ROOT}/current")"
          if [ -n "${OLD_CURRENT:-}" ] && [ "${NEW_CURRENT}" = "${OLD_CURRENT}" ]; then
            echo "current symlink was not updated"
            exit 1
          fi

      - name: Smoke test macOS x86_64 bundle
        run: |
          set -euxo pipefail
          CFG="${RUNNER_TEMP}/ccm-test/config"
          "${RUNNER_TEMP}/ccm-test/bin/ccm" --config-dir "${CFG}" doctor
          "${RUNNER_TEMP}/ccm-test/bin/ccm" --config-dir "${CFG}" list --pretty
          "${RUNNER_TEMP}/ccm-test/bin/cursor-cli-manager" --config-dir "${CFG}" list

  smoke-macos-arm64:
    runs-on: macos-latest
    needs:
      - build-macos-arm64
    env:
      UPGRADE_FROM_TAG: v0.6.4
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: ccm-macos-arm64.tar.gz
          path: dist

      - name: Prepare checksums.txt
        run: |
          set -euxo pipefail
          cd dist
          shasum -a 256 ccm-macos-arm64.tar.gz > checksums.txt

      - name: Download old macOS arm64 asset
        run: |
          set -euxo pipefail
          OLD_DIR="${RUNNER_TEMP}/ccm-old"
          OLD_ASSET="ccm-macos-arm64.tar.gz"
          OLD_URL="https://github.com/${{ github.repository }}/releases/download/${UPGRADE_FROM_TAG}/${OLD_ASSET}"
          mkdir -p "${OLD_DIR}"
          curl -fsSL "${OLD_URL}" -o "${OLD_DIR}/${OLD_ASSET}"
          (cd "${OLD_DIR}" && shasum -a 256 "${OLD_ASSET}" > checksums.txt)

      - name: Install old macOS arm64 bundle
        run: |
          set -euxo pipefail
          export CCM_INSTALL_FROM_DIR="${RUNNER_TEMP}/ccm-old"
          export CCM_INSTALL_DEST="${RUNNER_TEMP}/ccm-test/bin"
          export CCM_INSTALL_ROOT="${RUNNER_TEMP}/ccm-test/root"
          export CCM_INSTALL_TAG="${UPGRADE_FROM_TAG}"
          export CCM_INSTALL_OS="Darwin"
          export CCM_INSTALL_ARCH="arm64"
          mkdir -p "${CCM_INSTALL_DEST}" "${CCM_INSTALL_ROOT}" "${RUNNER_TEMP}/ccm-test/config"
          sh scripts/install_ccm.sh
          echo "OLD_CURRENT=$(readlink "${CCM_INSTALL_ROOT}/current")" >> "${GITHUB_ENV}"

      - name: Upgrade to new macOS arm64 bundle
        run: |
          set -euxo pipefail
          export CCM_INSTALL_FROM_DIR="${PWD}/dist"
          export CCM_INSTALL_DEST="${RUNNER_TEMP}/ccm-test/bin"
          export CCM_INSTALL_ROOT="${RUNNER_TEMP}/ccm-test/root"
          export CCM_INSTALL_OS="Darwin"
          export CCM_INSTALL_ARCH="arm64"
          unset CCM_INSTALL_TAG || true
          sh scripts/install_ccm.sh
          NEW_CURRENT="$(readlink "${CCM_INSTALL_ROOT}/current")"
          if [ -n "${OLD_CURRENT:-}" ] && [ "${NEW_CURRENT}" = "${OLD_CURRENT}" ]; then
            echo "current symlink was not updated"
            exit 1
          fi

      - name: Smoke test macOS arm64 bundle
        run: |
          set -euxo pipefail
          CFG="${RUNNER_TEMP}/ccm-test/config"
          "${RUNNER_TEMP}/ccm-test/bin/ccm" --config-dir "${CFG}" doctor
          "${RUNNER_TEMP}/ccm-test/bin/ccm" --config-dir "${CFG}" list --pretty
          "${RUNNER_TEMP}/ccm-test/bin/cursor-cli-manager" --config-dir "${CFG}" list

  publish:
    runs-on: ubuntu-latest
    needs:
      - build-linux-x86_64-glibc217
      - build-linux-x86_64-nc5
      - build-linux-x86_64-nc6
      - build-macos-x86_64
      - build-macos-arm64
      - smoke-linux
      - smoke-macos-x86_64
      - smoke-macos-arm64
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Prepare checksums.txt
        run: |
          set -euxo pipefail
          (cd dist && sha256sum ccm-*.tar.gz > checksums.txt)
          ls -la dist

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/ccm-*
            dist/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

